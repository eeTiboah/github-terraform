
name: "Terraform action"

on: push
      
permissions:
      id-token: write 
      contents: read 
      pull-requests: write

jobs:
  Terraform-Security-Scan:
    runs-on: ubuntu-latest
    steps:
      - name: Terraform tfsec
        uses: aquasecurity/tfsec-pr-commenter-action@v1.2.0
        with:
          github_token: ${{ github.token }}
        continue-on-error: true               #TODO 

  Terraform-Dev-Plan:
    needs: [ Terraform-Security-Scan ]
    uses: ./.github/workflows/plan.yaml
    with:
      env: "dev"
    secrets:
      accountID: ${{ secrets.ACCOUNT_ID }}
      roleName: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE }}
      region: ${{ secrets.AWS_REGION }}

  Terraform-Dev-Apply:
    needs: [ Terraform-Dev-Plan]
    uses: ./.github/workflows/apply.yaml
    with:
      env: "dev"
    secrets:
      accountID: ${{ secrets.ACCOUNT_ID }}
      roleName: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE }}
      region: ${{ secrets.AWS_REGION }}

  # Terraform-Prod-Plan:
  #   needs: [ Terraform-Dev-Apply]
  #   uses: ./.github/workflows/plan.yaml
  #   with:
  #     env: "prod"
  #   secrets:
  #     accountID: ${{ secrets.PROD_ACCOUNT_ID }}
  #     roleName: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE }}
  #     region: ${{ secrets.AWS_REGION }}

  # Terraform-Prod-Apply:
  #   needs: [ Terraform-Prod-Plan]
  #   uses: ./.github/workflows/apply.yaml
  #   with:
  #     env: "prod"
  #   secrets:
  #     accountID: ${{ secrets.PROD_ACCOUNT_ID }}
  #     roleName: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE }}
  #     region: ${{ secrets.AWS_REGION }}